#!/usr/bin/env bash
# Run test suites for nit implementations
source "$(dirname "$0")/lib.sh"

LANGUAGE=""
VERBOSE=false

show_help() {
    cat <<'EOF'
test - Run test suites for nit implementations

Usage: test [options]

Options:
  -h, --help              Show this help message
  -l, --language LANG     Run tests for specific language only (rust, zig, ruby)
  -v, --verbose           Show verbose test output

Examples:
  test                    Run all implementation tests
  test -l rust            Run only Rust tests
  test --language zig     Run only Zig tests
  test -l ruby            Run only Ruby tests
  test -v                 Run all tests with verbose output
EOF
}

run_rust_tests() {
    local rust_dir="${SCRIPT_DIR}/../rust"
    if [[ ! -d "$rust_dir" ]]; then
        echo "Rust implementation not found at $rust_dir"
        return 1
    fi

    echo "=== Running Rust tests ==="
    echo

    local cargo_opts=()
    if $VERBOSE; then
        cargo_opts+=("--" "--nocapture")
    fi

    (cd "$rust_dir" && cargo test "${cargo_opts[@]}")
    local status=$?

    echo
    if [[ $status -eq 0 ]]; then
        echo "✓ Rust tests passed"
    else
        echo "✗ Rust tests failed"
    fi
    return $status
}

run_zig_tests() {
    local zig_dir="${SCRIPT_DIR}/../zig"
    if [[ ! -d "$zig_dir" ]]; then
        echo "Zig implementation not found at $zig_dir"
        return 1
    fi

    echo "=== Running Zig tests ==="
    echo

    local zig_opts=()
    if $VERBOSE; then
        zig_opts+=("--summary" "all")
    fi

    (cd "$zig_dir" && zig build test "${zig_opts[@]}")
    local status=$?

    echo
    if [[ $status -eq 0 ]]; then
        echo "✓ Zig tests passed"
    else
        echo "✗ Zig tests failed"
    fi
    return $status
}

run_ruby_tests() {
    local ruby_dir="${SCRIPT_DIR}/../ruby"
    if [[ ! -d "$ruby_dir" ]]; then
        echo "Ruby implementation not found at $ruby_dir"
        return 1
    fi

    echo "=== Running Ruby tests ==="
    echo

    local rspec_opts=()
    if $VERBOSE; then
        rspec_opts+=("--format" "documentation")
    fi

    (cd "$ruby_dir" && bundle exec rspec "${rspec_opts[@]}")
    local status=$?

    echo
    if [[ $status -eq 0 ]]; then
        echo "✓ Ruby tests passed"
    else
        echo "✗ Ruby tests failed"
    fi
    return $status
}

main() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -l|--language)
                LANGUAGE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -*)
                echo "Unknown option: $1"
                echo "Run 'test --help' for usage."
                exit 1
                ;;
            *)
                echo "Unexpected argument: $1"
                echo "Run 'test --help' for usage."
                exit 1
                ;;
        esac
    done

    # Validate language if specified
    if [[ -n "$LANGUAGE" ]]; then
        case "$LANGUAGE" in
            rust|zig|ruby) ;;
            *)
                echo "Unknown language: $LANGUAGE"
                echo "Supported: rust, zig, ruby"
                exit 1
                ;;
        esac
    fi

    local failed=0
    local run_count=0

    # Run tests based on language selection
    if [[ -z "$LANGUAGE" || "$LANGUAGE" == "rust" ]]; then
        run_rust_tests || failed=1
        run_count=$((run_count + 1))
        echo
    fi

    if [[ -z "$LANGUAGE" || "$LANGUAGE" == "zig" ]]; then
        run_zig_tests || failed=1
        run_count=$((run_count + 1))
        echo
    fi

    if [[ -z "$LANGUAGE" || "$LANGUAGE" == "ruby" ]]; then
        run_ruby_tests || failed=1
        run_count=$((run_count + 1))
    fi

    echo
    echo "=== Summary ==="
    if [[ $failed -eq 0 ]]; then
        echo "All $run_count implementation(s) passed"
    else
        echo "Some tests failed"
        exit 1
    fi
}

main "$@"
