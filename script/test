#!/usr/bin/env bash
# Run test suites for git-all implementations
source "$(dirname "$0")/lib.sh"

TYPE=""
VERBOSE=false

show_help() {
    cat <<EOF
test - Run test suites for git-all implementations

Usage: test [options]

Options:
  -h, --help              Show this help message
  -t, --type TYPE         Run tests for specific type only (rust, zig, crystal, spec)
  -v, --verbose           Show verbose test output

Examples:
  test                    Run all implementation tests
  test -t rust            Run only Rust tests
  test --type zig         Run only Zig tests
  test -t spec            Run integration specs (Ruby/RSpec)
  test -v                 Run all tests with verbose output
EOF
}

run_tests() {
    local impl="$1"
    local dir
    dir=$(get_impl_dir "$impl")

    if [[ ! -d "$dir" ]]; then
        echo "$impl implementation not found at $dir"
        return 1
    fi

    echo "=== Running $impl tests ==="
    echo

    local status=0
    case "$impl" in
        rust)
            local cargo_opts=()
            if $VERBOSE; then
                cargo_opts+=("--" "--nocapture")
            fi
            (cd "$dir" && cargo test "${cargo_opts[@]}")
            status=$?
            ;;
        zig)
            local zig_opts=()
            if $VERBOSE; then
                zig_opts+=("--summary" "all")
            fi
            (cd "$dir" && zig build test "${zig_opts[@]}")
            status=$?
            ;;
        crystal)
            local crystal_opts=()
            if $VERBOSE; then
                crystal_opts+=("--verbose")
            fi
            (cd "$dir" && crystal spec "${crystal_opts[@]}")
            status=$?
            ;;
        *)
            echo "Unknown implementation: $impl"
            return 1
            ;;
    esac

    echo
    if [[ $status -eq 0 ]]; then
        echo "✓ $impl tests passed"
    else
        echo "✗ $impl tests failed"
    fi
    return $status
}

run_spec_tests() {
    echo "=== Running integration specs ==="
    echo
    local rspec_opts=()
    if $VERBOSE; then
        rspec_opts+=("--format" "documentation")
    fi
    (cd "$GIT_ALL_ROOT" && bundle exec rspec "${rspec_opts[@]}")
    local status=$?
    echo
    if [[ $status -eq 0 ]]; then
        echo "✓ integration specs passed"
    else
        echo "✗ integration specs failed"
    fi
    return $status
}

main() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -t|--type)
                TYPE="$2"
                shift 2
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -*)
                echo "Unknown option: $1"
                echo "Run 'test --help' for usage."
                exit 1
                ;;
            *)
                echo "Unexpected argument: $1"
                echo "Run 'test --help' for usage."
                exit 1
                ;;
        esac
    done

    # Validate type if specified
    if [[ -n "$TYPE" ]]; then
        if [[ "$TYPE" == "spec" ]]; then
            run_spec_tests
            exit $?
        fi
        local valid=false
        for impl in $(discover_impl_names); do
            if [[ "$impl" == "$TYPE" ]]; then
                valid=true
                break
            fi
        done
        if ! $valid; then
            echo "Unknown type: $TYPE"
            echo "Available: $(discover_impl_names | tr '\n' ' ') spec"
            exit 1
        fi
    fi

    local failed=0
    local run_count=0

    # Get implementations to test
    local impls
    if [[ -n "$TYPE" ]]; then
        impls="$TYPE"
    else
        impls=$(discover_impl_names)
    fi

    for impl in $impls; do
        run_tests "$impl" || failed=1
        run_count=$((run_count + 1))
        echo
    done

    echo "=== Summary ==="
    if [[ $failed -eq 0 ]]; then
        echo "All $run_count implementation(s) passed"
    else
        echo "Some tests failed"
        exit 1
    fi
}

main "$@"
